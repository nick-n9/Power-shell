Sub RefreshForecast()
    Dim ws As Worksheet
    Dim conn As Object
    Dim rs As Object
    Dim sql As String
    Dim lastRow As Long
    Dim forecastedId As String
    Dim i As Long
    Dim dbConnectionString As String
    
    Set ws = ThisWorkbook.Sheets("Sheet1")

    forecastedId = ws.Range("J2").Value
    
    If forecastedId = "" Then
        MsgBox "Please enter a ForecastedObjectId in J2.", vbExclamation, "Input Required"
        Exit Sub
    End If
    
    lastRow = ws.Cells(ws.Rows.Count, 1).End(xlUp).Row
    
    For i = 2 To lastRow
        If ws.Cells(i, 1).Value = forecastedId Then
            If Trim(ws.Cells(i, 6).Value) = "" Then
                ws.Cells(i, 7).Value = ws.Cells(i, 5).Value
            Else
                ws.Cells(i, 7).Value = ws.Cells(i, 6).Value + ws.Cells(i, 3).Value
            End If
            
            On Error Resume Next
            Set conn = CreateObject("ADODB.Connection")
            dbConnectionString = "Provider=SQLOLEDB;Data Source=YOUR_SERVER;Initial Catalog=YOUR_DATABASE;Integrated Security=SSPI;"
            conn.Open dbConnectionString
            
            If conn.State = 0 Then
                MsgBox "Database connection failed.", vbCritical, "Error"
                Exit Sub
            End If
            
            sql = "UPDATE ForecastNew SET FinalForecast = " & ws.Cells(i, 7).Value & _
                  " WHERE ForecastedObjectId = '" & forecastedId & "'"
            
            conn.Execute sql
            
            conn.Close
            Set conn = Nothing
            
            MsgBox "Final Forecast updated successfully!", vbInformation, "Success"
            Exit Sub
        End If
    Next i

    MsgBox "ForecastedObjectId not found in the sheet!", vbExclamation, "Not Found"
End Sub
